<!doctype html>	
<html>

<head>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no" />
   <title>Generate classed color breaks renderer</title>
   <link rel="stylesheet" href="https://js.arcgis.com/3.18/dijit/themes/tundra/tundra.css">
   <link rel="stylesheet" href="https://js.arcgis.com/3.18/esri/css/esri.css">
   <style>
      html,
      body {
         height: 100%;
         width: 100%;
         margin: 0;
         padding: 0;
      }
      #map {
         margin: 0;
         padding: 0;
      }
      #legendWrapper {
         position: absolute;
         height: 250px;
         font-family: arial;
         margin: 5px;
         padding: 10px;
         z-index: 40;
         background: #fff;
         color: #444;
         width: 300px;
         left: 60px;
         top: 30px;
         box-shadow: 0 0 5px #888;
      }    
  </style>
  <script src="https://js.arcgis.com/3.18/"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <script type="text/javascript">
    require([
      "esri/map",
      "esri/layers/VectorTileLayer",
      "esri/layers/FeatureLayer",
      "esri/renderers/smartMapping",
      "esri/renderers/SimpleRenderer", "esri/Color", 
      "esri/symbols/SimpleFillSymbol", "esri/symbols/SimpleLineSymbol", 
      "esri/tasks/query",
      "esri/dijit/Legend",
      "esri/geometry/Point",
      "dojo/dom",      
      "dojo/dom-construct",
      "dojo/domReady!"
    ], function(Map, VectorTileLayer, FeatureLayer, smartMapping, SimpleRenderer, Color, 
        SimpleFillSymbol, SimpleLineSymbol, Query, Legend, Point, dom, domConstruct) {

      var map = new Map("map", {
        center: [-78.65, 35.85], // longitude, latitude
        zoom: 9
      });
      var legend = null;
      var vtlayer = new VectorTileLayer("https://www.arcgis.com/sharing/rest/content/items/850db44b9eb845d3bd42b19e8aa7a024/resources/styles/root.json");
      map.addLayer(vtlayer);

      $.ajax({
        url: 'https://raw.githubusercontent.com/CORaleigh/dataviz_search/censusmap/data/construction-permitting.json',
        type: 'GET',
        dataType: 'json'
      })
      .done(function(data) {
          var where = "GEOID10 in (";
          var geoids = [];
          $.each(data, function (i, d) {
            geoids.push("'" + d.geoid_blgrp + "'");
          });

          where += geoids.toString() + ")";
        var featureLayer = new FeatureLayer("https://services1.arcgis.com/a7CWfuGP5ZnLYE7I/arcgis/rest/services/CensusBlockGroups2010/FeatureServer/0", 
          {
            definitionExpression: where, 
            outFields: ['*'], 
            mode: FeatureLayer.MODE_SNAPSHOT,
            minZoom: 8,
            opacity: 0.6
          }
        );
        var q = new Query();
        q.where = where;
        var cnt = 0;
        featureLayer.queryCount(q, function (count) {
          featureLayer.on('graphic-add', function (g) {
            var match = $(data).filter(function (i) {
              if (g.graphic.attributes) {
                return data[i].geoid_blgrp === g.graphic.attributes.GEOID10.toString();
              }
            });
            if (match.length > 0) {
              g.graphic.attributes.count_permitnum = parseInt(match[0].count_permitnum);
              g.graphic.attributes.sum_estprojectcost = parseInt(match[0].sum_estprojectcost);
            }
            console.log(g);
            if (cnt === count - 1) {
              setRenderer(featureLayer, smartMapping);
            }
            cnt += 1;
          });
        });
        map.addLayer(featureLayer);
        featureLayer.on("load", function(){
          navigator.geolocation.getCurrentPosition(function (position) {
            map.centerAndZoom(new Point(position.coords.longitude, position.coords.latitude), 12)
          })
        });
      })
      .fail(function() {
        console.log("error");
      })
      .always(function() {
        console.log("complete");
      });

    function setRenderer (featureLayer, smartMapping) {
        featureLayer.fields.push({
          alias: 'Estimated Project Cost',
          editable: true,
          name: 'sum_estprojectcost',
          nullable: true,
          type: 'esriFieldTypeDouble'
        });
        featureLayer.fields.push({
          alias: 'Count',
          editable: true,
          name: 'Permits',
          nullable: true,
          type: 'esriFieldTypeDouble'
        });        
            //smart mapping functionality begins
            smartMapping.createClassedColorRenderer({
               layer: featureLayer,
               field: 'sum_estprojectcost',
               basemap: 'dark-gray',
               classificationMethod: "quantile"
            }).then(function (response) {
               featureLayer.setRenderer(response.renderer);
               featureLayer.redraw();
               createLegend(map, featureLayer, 'sum_estprojectcost');
            });
    }
         //Create a legend
         function createLegend(map, layer, field) {
            //If applicable, destroy previous legend
            if (legend) {
               legend.destroy();
               domConstruct.destroy(dom.byId("legendDiv"));
            }

           // create a new div for the legend
            var legendDiv = domConstruct.create("div", {
               id: "legendDiv"
            }, dom.byId("legendWrapper"));

            legend = new Legend({
               map: map,
               layerInfos: [{
                  layer: layer,
                  title: " "
            }]
            }, legendDiv);
            legend.startup();
         };      
    });


  </script>
		</head>
		<body>
<div id="map"><div id="legendWrapper"></div></div>
		</body>
	</html>  